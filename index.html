<body style="background: white"></body>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<script src="https://unpkg.com/tone"></script>
<script src="https://algorithmicmusic.online/js/viz-helpers.js"></script>
<script>
  /* global nn, Tone, viz */
  
  // sources
  
  const path = 'https://tonejs.github.io/audio/drum-samples/Stark/'
  const drumset = new Tone.Players({
    kick: path + 'kick.mp3',
    snare: path + 'snare.mp3',
    hihat: path + 'hihat.mp3',
    tom1: path + 'tom1.mp3',
    tom2: path + 'tom2.mp3',
    tom3: path + 'tom3.mp3'
  })
  
  const volume = new Tone.Gain(0.5)
  
  drumset.connect(volume)
  
  volume.toDestination()
  
  
  // musical settings
  
  // Transport settings
  Tone.Transport.bpm.value = 240
  Tone.Transport.timeSignature = 4
  // Tone.Transport.loop = true
  Tone.Transport.loopend = "10m"
  
  
  const list_players = ["kick", "snare", "hihat", "tom1", "tom2", "tom3"]
  
  // functions
  function toggle(){
    if (Tone.Transport.state === "stopped"){
      Tone.Transport.start()
      this.content("stop")
    }
    else{
      Tone.Transport.stop()
      this.content("start")
    }
  }
  
  // the chance calculation 
  function cal_chance(player, bar, beat){
    if (player === "kick") {
      if (bar < 5) {
        return 0
      }
      else {
        if (beat % 4 === 0) {
          return nn.random()
        } else {
          return 0
        }
      }
    }
    
    if (player === "snare") {
      if (bar < 5) {
        if (beat % 4 === 0) {
          return 1
        } else {
          return 0
        }
      }
      else {
        return nn.random(0, 0.8) 
      }
    }
    
    if (player === "hihat") {
      if (bar < 5) {
        return 0
      }
      else {
        if (nn.random() > 0.8){
          return 0
        } else{
          return 0
        }
      }
    }
    
    if (player === "tom1") {
      if (bar < 5) {
        if (beat % 2 === 0) {
          return 1
        } else {
          return 0
        }
      }
      else {
        return nn.random(0, 1.1)
      }
    }
    
    if (player === "tom2") {
      if (bar < 5) {
        if (beat % 3 === 0) {
          return 1
        } else {
          return nn.random()
        }
      }
      else {
        return nn.random()
      }
    }
    
    if (player === "tom3") {
      if (bar < 5) {
        if (beat % 3 === 0) {
          return 1
        } else {
          return nn.random()
        }
      }
      else {
        if (nn.random(0, 1) > 0.2) {
          return 2
        } else {
          return nn.random()
        }
      }
    }
  }
  
  
  
  function play(time){
    
    const pos = Tone.Transport.position.split(":").map(Number)
    const bar = pos[0]
    const beat = pos[1]
    
    if (bar >= 5){
      label.css({
        color: "red"
      })
    }
    
    for (const player of list_players){
      if (cal_chance(player, bar, beat) > 0.5) {
        drumset.player(player).start(time)
      }
      if (cal_chance(player, bar, beat) > 1) {
        drumset.player(player).start(time + (30 / Tone.Transport.bpm.value))
      }
    }
    
    label.content(`measure: ${bar}, beat: ${beat}`)
  }
  
  function updateBPM () {
    Tone.Transport.bpm.value = this.value
  }
  
  new Tone.Loop(play).start()

  // UI
  
  nn.create("button")
    .content("start")
    .addTo("body")
    .on("click", toggle)
  
  nn.create("input")
    .set("type", "number")
    .set("value", Tone.Transport.bpm.value)
    .addTo("body")
    .on("change", updateBPM)
  
  nn.create("br").addTo("body")
  
  const label = nn.create("label")
                 .css({
                   color: "blue"
                 })
                 .content("measure: 0, beat: 0")
                 .addTo("body")
  
  nn.create("br").addTo("body")
  nn.create("br").addTo("body")
  nn.create("label")
    .content("I started with the code that I followed coding during lecture and built on that. I first chose a drumset that I liked, and then I began thinking of right now with only nn.random() or beat % a_number === 0, there is just not enough variations. Therefore, I decided to make more possible restrictions by using a function called cal_chance that takes in a player's name and then basically calculate a probability that it should play. In this way, it is easier to manage how I would want them to appear more frequently or at a specific point. As I wanted a intro, I also added a variation that the first 5 measures of should not be the same when calculating the chances. To further increase the variations of the rhythm, I thought I can also make the drums play a second time before the next beat, so I added that if chance > 1, then the drum will also play a second time befor the next beat. Then, I referrenced the template of the assignment, I changed the the way that beats were calculated which is through incrementing steps each time to use Transport's own property like in the template, and added a UI to display measure and beat.")
    .addTo("body")
  nn.create("br").addTo("body")
  nn.create("label")
    .content("During the above steps, I didn't intend to use Tone.Transport.loop = true because it would destroy the intro part as the intro part would come back again. But later I wanted to test if it actually sounds good for the intro part to repeat, after setting Tone.Transport.loop = true it will produce a very high pitch tone. After asking claude about it, it cannot pinpoint the problem. The problem is indeed pretty weird. ")
    .addTo("body")
  
  
</script>